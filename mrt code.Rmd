---
title: "MRT main"
author: "Samuel Montalvo, Ph.D"
date: "2024-12-26"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(ggpubr)
library(ggprism)
library(lme4)
library(lmerTest)
library(janitor)
library(emmeans)
library(mediation)
library(sjPlot)
```

# Load data


```{r cars}
# Load the specific sheet from the Excel file
key_data <- read_excel("mrt_data_clean.xlsx", 
                               sheet = "demographics_key") 

isokinetic_data <- read_excel("mrt_data_clean.xlsx", 
                               sheet = "isokinetic") 

strength_data <- read_excel("mrt_data_clean.xlsx", 
                               sheet = "Isometric-1RM") 

dexa_data <- read_excel("mrt_data_clean.xlsx", 
                               sheet = "DEXA") 

dexa_data <- clean_names(dexa_data)
```

```{r}
vars_to_max <- c("isometric_bp", "isometric_mtp",
                 "onerm_bp", "onerm_lp")

strength_data <- strength_data %>%
  group_by(id, time) %>%
  summarize(
    across(all_of(vars_to_max),
           ~ max(.x, na.rm = TRUE),
           .names = "max_{col}"),
    .groups = "drop"
  )
strength_data
```



```{r}
df <- key_data %>% left_join(isokinetic_data, by= "id") 

merged_df <- df %>%
  left_join(strength_data, by= c( "id","time")) %>%
  left_join(dexa_data, by= c( "id","time")) 

merged_df$time <- factor(merged_df$time,
                         levels = c("pre", "post"))

merged_df
```

# mixed models 

```{r}
merged_df <- merged_df %>%
  mutate(
    lean_kg_total = lean_g_total * 0.001,
    lean_kg_arms = lean_g_arms * 0.001,  # Assuming original is lean_g_arms
    lean_kg_legs = lean_g_legs * 0.001   # Assuming original is lean_g_legs
    # Add lines here for Biodex if they need simple mutations, e.g.:
    # biodex_away_nm = biodex_away_raw * conversion_factor, # Example
    # biodex_towards_nm = biodex_towards_raw * conversion_factor # Example
  )

# Verify the new columns have been created (optional check)
# print(colnames(merged_df))
```


## lean muscle mass
```{r}
model1 <- lmer(lean_kg_total ~ time*group + sex + weight_scale + (1|id),data=merged_df)
summary(model1)
```

```{r}
emm_overall <- emmeans(model1, ~ time | group)
contrast(emm_overall, method = "pairwise")
```

## leg press
```{r}
model_lp <- lmer(max_onerm_lp ~ time*group  + weight_scale + (1|id),data=merged_df)
summary(model_lp)
```

```{r}
library(emmeans)

# EMMs for the time*group interaction
em <- emmeans(model_lp, ~ time | group)
contrast(em, method = "pairwise")

```
## lean arms
```{r}
model_la <- lmer(lean_kg_arms ~ time*group + sex + weight_scale + (1|id), data=merged_df)
summary(model_la)
```

```{r}
library(emmeans)

# EMMs for the time*group interaction
emm_la <- emmeans(model_la, ~ time | group)
contrast(emm_la, method = "pairwise")
```
## lean press
```{r}
model_ll <- lmer(lean_kg_legs ~ time*group + sex + weight_scale + (1|id), data=merged_df)
summary(model_ll)
```
```{r}
library(emmeans)

# EMMs for the time*group interaction
emm_ll <- emmeans(model_ll, ~ time | group)
contrast(emm_ll, method = "pairwise")
```
## iso benh press
```{r}
model_iso_bp <- lmer(max_isometric_bp ~ time*group + weight_scale + (1|id), data=merged_df)
summary(model_iso_bp)
```
```{r}
library(emmeans)

# EMMs for the time*group interaction
emm_iso_bp <- emmeans(model_iso_bp, ~ time | group)
contrast(emm_iso_bp, method = "pairwise")
```
## dynamic bench press (1RM) 

```{r}
model_bp <- lmer(max_onerm_bp ~ time*group + weight_scale + (1|id), data=merged_df)
summary(model_bp)
```

```{r}
library(emmeans)

# EMMs for the time*group interaction
emm_bp <- emmeans(model_bp, ~ time | group)
contrast(emm_bp, method = "pairwise")
```

## IMPT
```{r}
model_imtp <- lmer(max_isometric_mtp ~ time*group + weight_scale + (1|id), data=merged_df)
summary(model_imtp)
```
```{r}
library(emmeans)

# EMMs for the time*group interaction
emm_imtp <- emmeans(model_imtp, ~ time | group)
contrast(emm_imtp, method = "pairwise")
```
## biodex away
```{r}
model_biodex_away <- lmer(away ~ time*group + weight_scale + (1|id), data=merged_df)
summary(model_biodex_away)
```
```{r}
library(emmeans)

# EMMs for the time*group interaction
emm_biodex_away <- emmeans(model_biodex_away, ~ time | group)
contrast(emm_biodex_away, method = "pairwise")
```
## biodex towards
```{r}
model_biodex_towards <- lmer(towards ~ time*group + weight_scale + (1|id), data=merged_df)
summary(model_biodex_towards)
```

```{r}
library(emmeans)

# EMMs for the time*group interaction
emm_biodex_towards <- emmeans(model_biodex_towards, ~ time | group)
contrast(emm_biodex_towards, method = "pairwise")
```


### table
```{r}
library(sjPlot)
tab_model(model1,model_lp, show.obs = FALSE,  show.re.var = TRUE, show.ngroups = FALSE#, #show.p = FALSE, #p.style = "numeric_stars")
```


```{r}
emm_overall <- emmeans(model_lp_t, ~ time | group*sex)
contrast(emm_overall, method = "pairwise")
```


#mediation

```{r}
## --------------- 1.  MRT  versus  Control -------------------------------
df_mrt <- merged_df |>
  filter(group %in% c("Control", "MRT")) |>   # keep only two arms
  mutate(group = factor(group, levels = c("Control", "MRT"))) |>   # Control = 0
  droplevels()

med_mrt <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_mrt,
  REML = FALSE
)

out_mrt <- lme4::lmer(
  max_onerm_lp  ~ time * group + sex + lean_kg_total  + weight_scale + (1 | id),
  data = df_mrt,
  REML = FALSE
)

set.seed(123)
mrt_med <- mediate(
  model.m   = med_mrt,
  model.y   = out_mrt,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000            # quasi-Bayesian Monte-Carlo draws
)

summary(mrt_med)      # ACME ≈ 52 kg (p = .042), ADE ≈ –12 kg (ns)

## --------------- 2.  WRT  versus  Control -------------------------------

df_wrt <- merged_df |>
  filter(group %in% c("Control", "WRT")) |>            # only two arms
  mutate(group = factor(group, levels = c("Control", "WRT"))) |>
  droplevels()

med_wrt <- lme4::lmer(
  lean_kg_total ~ time * group + sex  + weight_scale + (1 | id),
  data = df_wrt,
  REML = FALSE
)

out_wrt <- lme4::lmer(
  max_onerm_lp  ~ time * group + sex + lean_kg_total  + weight_scale + (1 | id),
  data = df_wrt,
  REML = FALSE
)

set.seed(123)
wrt_med <- mediate(
  model.m   = med_wrt,
  model.y   = out_wrt,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(wrt_med)      # ACME ≈ 37 kg (p ≈ .21), ADE ≈   6 kg (ns)


```


```{r}
###############################################################################
#  Pooled Resistance Training (RT = MRT + WRT) versus Control
###############################################################################


## 1.  Create a two-level treatment factor (Control, RT)
df_rt <- merged_df %>%
  mutate(group_rt = ifelse(group == "Control", "Control", "RT"),
         group_rt = factor(group_rt, levels = c("Control", "RT")))  %>%
  droplevels()                               # keep only the two levels

## 2.  Fit the mediator model (lean mass)
med_rt <- lme4::lmer(
  lean_kg_total ~ time * group_rt + sex   + weight_scale + (1 | id),
  data = df_rt,
  REML = FALSE
)

## 3.  Fit the outcome model (strength, includes mediator)
out_rt <- lme4::lmer(
  max_onerm_lp  ~ time * group_rt + sex + lean_kg_total  + weight_scale + (1 | id),
  data = df_rt,
  REML = FALSE
)

## 4.  Causal mediation (quasi-Bayesian Monte-Carlo CIs)
set.seed(123)
rt_med <- mediate(
  model.m   = med_rt,
  model.y   = out_rt,
  treat     = "group_rt",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(rt_med)

```

## Forest plot

```{r}

###############################################################################
#  Forest plot for MRT, WRT and pooled RT – robust to any mediation version
###############################################################################

library(dplyr)
library(ggplot2)
library(scales)

# ── 1.  Helper to extract ACME & ADE from a mediate object ──────────────────
extract_med <- function(obj, label){
  data.frame(
    term      = c("ACME", "ADE"),
    estimate  = c(obj$d.avg,  obj$z.avg),
    conf.low  = c(obj$d.avg.ci[1], obj$z.avg.ci[1]),
    conf.high = c(obj$d.avg.ci[2], obj$z.avg.ci[2]),
    contrast  = label
  )
}

# ── 2.  Build plotting data frame ───────────────────────────────────────────
df_forest <- bind_rows(
  extract_med(mrt_med, "MRT vs Control"),
  extract_med(wrt_med, "WRT vs Control"),
  extract_med(rt_med,  "RT  vs Control")
) |>
  mutate(contrast = factor(contrast,
           levels = c("RT  vs Control", "WRT vs Control", "MRT vs Control")))

# ── 3.  Forest plot ─────────────────────────────────────────────────────────
p <- ggplot(df_forest,
            aes(estimate, contrast, colour = term)) +
  geom_vline(xintercept = 0, linetype = "dashed", linewidth = .4) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high),
                  position = position_dodge(width = .6), size = .9) +
  geom_text(aes(label = round(estimate, 1)),
            nudge_y  = 0.25, size = 3.3, colour = "black") +
  scale_colour_manual(values = c(ACME = "#0072B2", ADE = "#D55E00"),
                      labels = c("Indirect (ACME)", "Direct (ADE)"),
                      name   = NULL) +
  scale_x_continuous(breaks = pretty_breaks(7)) +
  labs(x = "Effect on leg-press 1 RM (kg)", y = NULL,
       title = "Indirect (hypertrophy-mediated) and direct effects") +
  theme_minimal(base_size = 13) +
  theme(legend.position    = "top",
        panel.grid.major.y = element_blank())

print(p)

ggsave("Forest_ACME_ADE_all_three_LP.png",
       p, width = 6.5, height = 4.5, dpi = 300)

```

## Mediation: lean_kg_total -> max_isometric_bp (MRT vs Control)

```{r mediation_LKT_isoBP_MRTvsCON}
# 1. MRT versus Control for max_isometric_bp mediated by lean_kg_total

# Filter data for Control and MRT (reuse df_mrt if appropriate or re-filter for clarity)
df_mrt_isoBP <- merged_df |>
  filter(group %in% c("Control", "MRT")) |>
  mutate(group = factor(group, levels = c("Control", "MRT"))) |>
  droplevels()

# Mediator model (lean_kg_total) - Identical to Samuel's med_mrt
med_mrt_LKT_isoBP <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_mrt_isoBP,
  REML = FALSE
)

# Outcome model (max_isometric_bp), with lean_kg_total as mediator
out_mrt_LKT_isoBP <- lme4::lmer(
  max_isometric_bp ~ time * group + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_mrt_isoBP,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_mrt_LKT_isoBP <- mediate(
  model.m   = med_mrt_LKT_isoBP,
  model.y   = out_mrt_LKT_isoBP,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_mrt_LKT_isoBP)
```
## Mediation: lean_kg_total -> max_isometric_bp (WRT vs Control)

```{r mediation_LKT_isoBP_WRTvsCON}
# 2. WRT versus Control for max_isometric_bp mediated by lean_kg_total

# Filter data for Control and WRT (reuse df_wrt or re-filter)
df_wrt_isoBP <- merged_df |>
  filter(group %in% c("Control", "WRT")) |>
  mutate(group = factor(group, levels = c("Control", "WRT"))) |>
  droplevels()

# Mediator model (lean_kg_total) - Identical to Samuel's med_wrt
med_wrt_LKT_isoBP <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_wrt_isoBP,
  REML = FALSE
)

# Outcome model (max_isometric_bp), with lean_kg_total as mediator
out_wrt_LKT_isoBP <- lme4::lmer(
  max_isometric_bp ~ time * group + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_wrt_isoBP,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_wrt_LKT_isoBP <- mediate(
  model.m   = med_wrt_LKT_isoBP,
  model.y   = out_wrt_LKT_isoBP,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_wrt_LKT_isoBP)
```
## Mediation : lean_kg_total -> max_isometric_bp (Pooled RT vs Control)

```{r mediation_LKT_isoBP_RTvsCON}
# 3. Pooled RT versus Control for max_isometric_bp mediated by lean_kg_total

# Create a two-level treatment factor (Control, RT)
df_rt_isoBP <- merged_df %>%
  mutate(
    group_rt = ifelse(group == "Control", "Control", "RT"),
    group_rt = factor(group_rt, levels = c("Control", "RT"))
  ) %>%
  droplevels() # Ensure only these two levels exist if coming from a factor with more

# Mediator model (lean_kg_total)
med_rt_LKT_isoBP <- lme4::lmer(
  lean_kg_total ~ time * group_rt + sex + weight_scale + (1 | id),
  data = df_rt_isoBP,
  REML = FALSE
)

# Outcome model (max_isometric_bp), with lean_kg_total as mediator
out_rt_LKT_isoBP <- lme4::lmer(
  max_isometric_bp ~ time * group_rt + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_rt_isoBP,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_rt_LKT_isoBP <- mediate(
  model.m   = med_rt_LKT_isoBP,
  model.y   = out_rt_LKT_isoBP,
  treat     = "group_rt",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_rt_LKT_isoBP)
```
## Mediation: lean_kg_total -> max_onerm_bp (MRT vs Control)

```{r mediation_LKT_maxBP_MRTvsCON}
# 1. MRT versus Control for max_onerm_bp mediated by lean_kg_total

# Filter data for Control and MRT
df_mrt_maxBP <- merged_df |>
  filter(group %in% c("Control", "MRT")) |>
  mutate(group = factor(group, levels = c("Control", "MRT"))) |>
  droplevels()

# Mediator model (lean_kg_total)
med_mrt_LKT_maxBP <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_mrt_maxBP,
  REML = FALSE
)

# Outcome model (max_onerm_bp), with lean_kg_total as mediator
out_mrt_LKT_maxBP <- lme4::lmer(
  max_onerm_bp ~ time * group + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_mrt_maxBP,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_mrt_LKT_maxBP <- mediate(
  model.m   = med_mrt_LKT_maxBP,
  model.y   = out_mrt_LKT_maxBP,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_mrt_LKT_maxBP)
```
## Mediation: lean_kg_total -> max_onerm_bp (WRT vs Control)


```{r mediation_LKT_maxBP_WRTvsCON}
# 2. WRT versus Control for max_onerm_bp mediated by lean_kg_total

# Filter data for Control and WRT
df_wrt_maxBP <- merged_df |>
  filter(group %in% c("Control", "WRT")) |>
  mutate(group = factor(group, levels = c("Control", "WRT"))) |>
  droplevels()

# Mediator model (lean_kg_total)
med_wrt_LKT_maxBP <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_wrt_maxBP,
  REML = FALSE
)

# Outcome model (max_onerm_bp), with lean_kg_total as mediator
out_wrt_LKT_maxBP <- lme4::lmer(
  max_onerm_bp ~ time * group + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_wrt_maxBP,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_wrt_LKT_maxBP <- mediate(
  model.m   = med_wrt_LKT_maxBP,
  model.y   = out_wrt_LKT_maxBP,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_wrt_LKT_maxBP)
```
## Mediation: lean_kg_total -> max_onerm_bp (Pooled RT vs Control) 

```{r mediation_LKT_maxBP_RTvsCON}
# 3. Pooled RT versus Control for max_onerm_bp mediated by lean_kg_total

# Create a two-level treatment factor (Control, RT)
df_rt_maxBP <- merged_df %>%
  mutate(
    group_rt = ifelse(group == "Control", "Control", "RT"),
    group_rt = factor(group_rt, levels = c("Control", "RT"))
  ) %>%
  droplevels()

# Mediator model (lean_kg_total)
med_rt_LKT_maxBP <- lme4::lmer(
  lean_kg_total ~ time * group_rt + sex + weight_scale + (1 | id),
  data = df_rt_maxBP,
  REML = FALSE
)

# Outcome model (max_onerm_bp), with lean_kg_total as mediator
out_rt_LKT_maxBP <- lme4::lmer(
  max_onerm_bp ~ time * group_rt + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_rt_maxBP,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_rt_LKT_maxBP <- mediate(
  model.m   = med_rt_LKT_maxBP,
  model.y   = out_rt_LKT_maxBP,
  treat     = "group_rt",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_rt_LKT_maxBP)
```
## Mediation: lean_kg_total -> max_isometric_mtp (MRT vs Control)

```{r mediation_LKT_IMTP_MRTvsCON}
# 1. MRT versus Control for max_isometric_mtp mediated by lean_kg_total

# Filter data for Control and MRT
df_mrt_IMTP <- merged_df |>
  filter(group %in% c("Control", "MRT")) |>
  mutate(group = factor(group, levels = c("Control", "MRT"))) |>
  droplevels()

# Mediator model (lean_kg_total)
med_mrt_LKT_IMTP <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_mrt_IMTP,
  REML = FALSE
)

# Outcome model (max_isometric_mtp), with lean_kg_total as mediator
out_mrt_LKT_IMTP <- lme4::lmer(
  max_isometric_mtp ~ time * group + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_mrt_IMTP,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_mrt_LKT_IMTP <- mediate(
  model.m   = med_mrt_LKT_IMTP,
  model.y   = out_mrt_LKT_IMTP,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_mrt_LKT_IMTP)
```
## Mediation: lean_kg_total -> max_isometric_mtp (WRT vs Control)

```{r mediation_LKT_IMTP_WRTvsCON}
# 2. WRT versus Control for max_isometric_mtp mediated by lean_kg_total

# Filter data for Control and WRT
df_wrt_IMTP <- merged_df |>
  filter(group %in% c("Control", "WRT")) |>
  mutate(group = factor(group, levels = c("Control", "WRT"))) |>
  droplevels()

# Mediator model (lean_kg_total)
med_wrt_LKT_IMTP <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_wrt_IMTP,
  REML = FALSE
)

# Outcome model (max_isometric_mtp), with lean_kg_total as mediator
out_wrt_LKT_IMTP <- lme4::lmer(
  max_isometric_mtp ~ time * group + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_wrt_IMTP,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_wrt_LKT_IMTP <- mediate(
  model.m   = med_wrt_LKT_IMTP,
  model.y   = out_wrt_LKT_IMTP,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_wrt_LKT_IMTP)
```
## Mediation: lean_kg_total -> max_isometric_mtp (Pooled RT vs Control)

```{r mediation_LKT_IMTP_RTvsCON}
# 3. Pooled RT versus Control for max_isometric_mtp mediated by lean_kg_total

# Create a two-level treatment factor (Control, RT)
df_rt_IMTP <- merged_df %>%
  mutate(
    group_rt = ifelse(group == "Control", "Control", "RT"),
    group_rt = factor(group_rt, levels = c("Control", "RT"))
  ) %>%
  droplevels()

# Mediator model (lean_kg_total)
med_rt_LKT_IMTP <- lme4::lmer(
  lean_kg_total ~ time * group_rt + sex + weight_scale + (1 | id),
  data = df_rt_IMTP,
  REML = FALSE
)

# Outcome model (max_isometric_mtp), with lean_kg_total as mediator
out_rt_LKT_IMTP <- lme4::lmer(
  max_isometric_mtp ~ time * group_rt + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_rt_IMTP,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_rt_LKT_IMTP <- mediate(
  model.m   = med_rt_LKT_IMTP,
  model.y   = out_rt_LKT_IMTP,
  treat     = "group_rt",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_rt_LKT_IMTP)
```
## Mediation: lean_kg_total -> away (MRT vs Control)

```{r mediation_LKT_away_MRTvsCON}
# 1. MRT versus Control for 'away' (Biodex away) mediated by lean_kg_total

# Filter data for Control and MRT
df_mrt_away <- merged_df |>
  filter(group %in% c("Control", "MRT")) |>
  mutate(group = factor(group, levels = c("Control", "MRT"))) |>
  droplevels()

# Mediator model (lean_kg_total)
med_mrt_LKT_away <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_mrt_away,
  REML = FALSE
)

# Outcome model ('away'), with lean_kg_total as mediator
out_mrt_LKT_away <- lme4::lmer(
  away ~ time * group + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_mrt_away,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_mrt_LKT_away <- mediate(
  model.m   = med_mrt_LKT_away,
  model.y   = out_mrt_LKT_away,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_mrt_LKT_away)
```

## Mediation: lean_kg_total -> away (WRT vs Control)

```{r mediation_LKT_away_WRTvsCON}
# 2. WRT versus Control for 'away' (Biodex away) mediated by lean_kg_total

# Filter data for Control and WRT
df_wrt_away <- merged_df |>
  filter(group %in% c("Control", "WRT")) |>
  mutate(group = factor(group, levels = c("Control", "WRT"))) |>
  droplevels()

# Mediator model (lean_kg_total)
med_wrt_LKT_away <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_wrt_away,
  REML = FALSE
)

# Outcome model ('away'), with lean_kg_total as mediator
out_wrt_LKT_away <- lme4::lmer(
  away ~ time * group + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_wrt_away,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_wrt_LKT_away <- mediate(
  model.m   = med_wrt_LKT_away,
  model.y   = out_wrt_LKT_away,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_wrt_LKT_away)
```

## Mediation: lean_kg_total -> away (Pooled RT vs Control)

```{r mediation_LKT_away_RTvsCON}
# 3. Pooled RT versus Control for 'away' (Biodex away) mediated by lean_kg_total

# Create a two-level treatment factor (Control, RT)
df_rt_away <- merged_df %>%
  mutate(
    group_rt = ifelse(group == "Control", "Control", "RT"),
    group_rt = factor(group_rt, levels = c("Control", "RT"))
  ) %>%
  droplevels()

# Mediator model (lean_kg_total)
med_rt_LKT_away <- lme4::lmer(
  lean_kg_total ~ time * group_rt + sex + weight_scale + (1 | id),
  data = df_rt_away,
  REML = FALSE
)

# Outcome model ('away'), with lean_kg_total as mediator
out_rt_LKT_away <- lme4::lmer(
  away ~ time * group_rt + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_rt_away,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_rt_LKT_away <- mediate(
  model.m   = med_rt_LKT_away,
  model.y   = out_rt_LKT_away,
  treat     = "group_rt",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_rt_LKT_away)
```

## Mediation: lean_kg_total -> towards (MRT vs Control)

```{r mediation_LKT_towards_MRTvsCON}
# 1. MRT versus Control for 'towards' (Biodex towards) mediated by lean_kg_total

# Filter data for Control and MRT
df_mrt_towards <- merged_df |>
  filter(group %in% c("Control", "MRT")) |>
  mutate(group = factor(group, levels = c("Control", "MRT"))) |>
  droplevels()

# Mediator model (lean_kg_total)
med_mrt_LKT_towards <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_mrt_towards,
  REML = FALSE
)

# Outcome model ('towards'), with lean_kg_total as mediator
out_mrt_LKT_towards <- lme4::lmer(
  towards ~ time * group + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_mrt_towards,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_mrt_LKT_towards <- mediate(
  model.m   = med_mrt_LKT_towards,
  model.y   = out_mrt_LKT_towards,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_mrt_LKT_towards)
```
## Mediation: lean_kg_total -> towards (WRT vs Control)

```{r mediation_LKT_towards_WRTvsCON}
# 2. WRT versus Control for 'towards' (Biodex towards) mediated by lean_kg_total

# Filter data for Control and WRT
df_wrt_towards <- merged_df |>
  filter(group %in% c("Control", "WRT")) |>
  mutate(group = factor(group, levels = c("Control", "WRT"))) |>
  droplevels()

# Mediator model (lean_kg_total)
med_wrt_LKT_towards <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_wrt_towards,
  REML = FALSE
)

# Outcome model ('towards'), with lean_kg_total as mediator
out_wrt_LKT_towards <- lme4::lmer(
  towards ~ time * group + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_wrt_towards,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_wrt_LKT_towards <- mediate(
  model.m   = med_wrt_LKT_towards,
  model.y   = out_wrt_LKT_towards,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_wrt_LKT_towards)
```

## Mediation: lean_kg_total -> towards (Pooled RT vs Control)

```{r mediation_LKT_towards_RTvsCON}
# 3. Pooled RT versus Control for 'towards' (Biodex towards) mediated by lean_kg_total

# Create a two-level treatment factor (Control, RT)
df_rt_towards <- merged_df %>%
  mutate(
    group_rt = ifelse(group == "Control", "Control", "RT"),
    group_rt = factor(group_rt, levels = c("Control", "RT"))
  ) %>%
  droplevels()

# Mediator model (lean_kg_total)
med_rt_LKT_towards <- lme4::lmer(
  lean_kg_total ~ time * group_rt + sex + weight_scale + (1 | id),
  data = df_rt_towards,
  REML = FALSE
)

# Outcome model ('towards'), with lean_kg_total as mediator
out_rt_LKT_towards <- lme4::lmer(
  towards ~ time * group_rt + sex + lean_kg_total + weight_scale + (1 | id),
  data = df_rt_towards,
  REML = FALSE
)

set.seed(123) # for reproducibility
mediation_rt_LKT_towards <- mediate(
  model.m   = med_rt_LKT_towards,
  model.y   = out_rt_LKT_towards,
  treat     = "group_rt",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(mediation_rt_LKT_towards)
```

