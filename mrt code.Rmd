---
title: "MRT main"
author: "Samuel Montalvo, Ph.D"
date: "2024-12-26"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(ggpubr)
library(ggprism)
library(lme4)
library(lmerTest)
library(janitor)
```

# Load data

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.


```{r cars}
# Load the specific sheet from the Excel file
key_data <- read_excel("mrt_data_clean.xlsx", 
                               sheet = "demographics_key") 

isokinetic_data <- read_excel("mrt_data_clean.xlsx", 
                               sheet = "isokinetic") 

strength_data <- read_excel("mrt_data_clean.xlsx", 
                               sheet = "Isometric-1RM") 

dexa_data <- read_excel("mrt_data_clean.xlsx", 
                               sheet = "DEXA") 

dexa_data <- clean_names(dexa_data)
```

```{r}
vars_to_max <- c("isometric_bp", "isometric_mtp",
                 "onerm_bp", "onerm_lp")

strength_data <- strength_data %>%
  group_by(id, time) %>%
  summarize(
    across(all_of(vars_to_max),
           ~ max(.x, na.rm = TRUE),
           .names = "max_{col}"),
    .groups = "drop"
  )
strength_data
```



```{r}
df <- key_data %>% left_join(isokinetic_data, by= "id") 

merged_df <- df %>%
  left_join(strength_data, by= c( "id","time")) %>%
  left_join(dexa_data, by= c( "id","time")) 

merged_df$time <- factor(merged_df$time,
                         levels = c("pre", "post"))

merged_df
```

# DEXA 

```{r}
merged_df <- merged_df %>% mutate(lean_kg_total = lean_g_total * 0.001)
```
## Doble interaction model
merged_df

```{r}
model1 <- lmer(lean_kg_total ~ time*group + sex + weight_dxa + (1|id),data=merged_df)
summary(model1)
```

```{r}
anova(model1)
```


```{r}
library(emmeans)

emm_overall <- emmeans(model1, ~ time | group)
contrast(emm_overall, method = "pairwise")
```




# Leg press
```{r}
model_lp <- lmer(max_onerm_lp ~ time*group  + weight_dxa + (1|id),data=merged_df)
summary(model_lp)
```


```{r}
library(emmeans)

# EMMs for the time*group interaction
em <- emmeans(model_lp, ~ time * group)
em
```


##  Leg press triple
```{r}
model_lp_t <- lmer(max_onerm_lp ~ time*group*sex + weight_dxa + (1|id),data=merged_df)
summary(model_lp_t)
```


```{r}
library(emmeans)

emm_overall <- emmeans(model_lp_t, ~ time | group*sex)
contrast(emm_overall, method = "pairwise")
```
#mediation

```{r}
## --------------- 1.  MRT  versus  Control -------------------------------

df_mrt <- merged_df |>
  filter(group %in% c("Control", "MRT")) |>   # keep only two arms
  mutate(group = factor(group, levels = c("Control", "MRT"))) |>   # Control = 0
  droplevels()

med_mrt <- lme4::lmer(
  lean_kg_total ~ time * group + sex + weight_scale + (1 | id),
  data = df_mrt,
  REML = FALSE
)

out_mrt <- lme4::lmer(
  max_onerm_lp  ~ time * group + sex + lean_kg_total  + weight_scale + (1 | id),
  data = df_mrt,
  REML = FALSE
)

set.seed(123)
mrt_med <- mediate(
  model.m   = med_mrt,
  model.y   = out_mrt,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000            # quasi-Bayesian Monte-Carlo draws
)

summary(mrt_med)      # ACME ≈ 52 kg (p = .042), ADE ≈ –12 kg (ns)

## --------------- 2.  WRT  versus  Control -------------------------------

df_wrt <- merged_df |>
  filter(group %in% c("Control", "WRT")) |>            # only two arms
  mutate(group = factor(group, levels = c("Control", "WRT"))) |>
  droplevels()

med_wrt <- lme4::lmer(
  lean_kg_total ~ time * group + sex  + weight_scale + (1 | id),
  data = df_wrt,
  REML = FALSE
)

out_wrt <- lme4::lmer(
  max_onerm_lp  ~ time * group + sex + lean_kg_total  + weight_scale + (1 | id),
  data = df_wrt,
  REML = FALSE
)

set.seed(123)
wrt_med <- mediate(
  model.m   = med_wrt,
  model.y   = out_wrt,
  treat     = "group",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(wrt_med)      # ACME ≈ 37 kg (p ≈ .21), ADE ≈   6 kg (ns)


```
```{r}
###############################################################################
#  Pooled Resistance Training (RT = MRT + WRT) versus Control
###############################################################################

library(dplyr)
library(lme4)
library(mediation)

## 1.  Create a two-level treatment factor (Control, RT)
df_rt <- merged_df %>%
  mutate(group_rt = ifelse(group == "Control", "Control", "RT"),
         group_rt = factor(group_rt, levels = c("Control", "RT")))  %>%
  droplevels()                               # keep only the two levels

## 2.  Fit the mediator model (lean mass)
med_rt <- lme4::lmer(
  lean_kg_total ~ time * group_rt + sex   + weight_scale + (1 | id),
  data = df_rt,
  REML = FALSE
)

## 3.  Fit the outcome model (strength, includes mediator)
out_rt <- lme4::lmer(
  max_onerm_lp  ~ time * group_rt + sex + lean_kg_total  + weight_scale + (1 | id),
  data = df_rt,
  REML = FALSE
)

## 4.  Causal mediation (quasi-Bayesian Monte-Carlo CIs)
set.seed(123)
rt_med <- mediate(
  model.m   = med_rt,
  model.y   = out_rt,
  treat     = "group_rt",
  mediator  = "lean_kg_total",
  sims      = 1000
)

summary(rt_med)

```

## Forest plot

```{r}

###############################################################################
#  Forest plot for MRT, WRT and pooled RT – robust to any mediation version
###############################################################################

library(dplyr)
library(ggplot2)
library(scales)

# ── 1.  Helper to extract ACME & ADE from a mediate object ──────────────────
extract_med <- function(obj, label){
  data.frame(
    term      = c("ACME", "ADE"),
    estimate  = c(obj$d.avg,  obj$z.avg),
    conf.low  = c(obj$d.avg.ci[1], obj$z.avg.ci[1]),
    conf.high = c(obj$d.avg.ci[2], obj$z.avg.ci[2]),
    contrast  = label
  )
}

# ── 2.  Build plotting data frame ───────────────────────────────────────────
df_forest <- bind_rows(
  extract_med(mrt_med, "MRT vs Control"),
  extract_med(wrt_med, "WRT vs Control"),
  extract_med(rt_med,  "RT  vs Control")
) |>
  mutate(contrast = factor(contrast,
           levels = c("RT  vs Control", "WRT vs Control", "MRT vs Control")))

# ── 3.  Forest plot ─────────────────────────────────────────────────────────
p <- ggplot(df_forest,
            aes(estimate, contrast, colour = term)) +
  geom_vline(xintercept = 0, linetype = "dashed", linewidth = .4) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high),
                  position = position_dodge(width = .6), size = .9) +
  geom_text(aes(label = round(estimate, 1)),
            nudge_y  = 0.25, size = 3.3, colour = "black") +
  scale_colour_manual(values = c(ACME = "#0072B2", ADE = "#D55E00"),
                      labels = c("Indirect (ACME)", "Direct (ADE)"),
                      name   = NULL) +
  scale_x_continuous(breaks = pretty_breaks(7)) +
  labs(x = "Effect on leg-press 1 RM (kg)", y = NULL,
       title = "Indirect (hypertrophy-mediated) and direct effects") +
  theme_minimal(base_size = 13) +
  theme(legend.position    = "top",
        panel.grid.major.y = element_blank())

print(p)

ggsave("Forest_ACME_ADE_all_three.png",
       p, width = 6.5, height = 4.5, dpi = 300)

```





### med 2

```{r}
library(lavaan)

model <- '
  lean_mass ~ group
  strength ~ group + lean_mass
  # Indirect effect
  ind := group * lean_mass
'

fit <- sem(model, data = merged_df)
summary(fit, fit.measures = TRUE, standardized = TRUE)


```


#old
```{r}
contrast(
  em,
  method = list(
    "MRT_pre_vs_post" = c(0, 0,  1, -1,  0,  0)),
  adjust = "holm"  # or "bonferroni", "holm", etc.
)
```

```{r}
contrast(
  em,
  method = list(
    "WRT_pre_vs_post" = c(0, 0,  0,  0,  1, -1)
  ),
  adjust = "holm"  # or "bonferroni", "holm", etc.
)
```


```{r}
em <- emmeans(model1, ~ time * group)  # your emmGrid

contrast(
  em,
  method = list(
    "MRT vs. WRT (post-pre)" = c(0, 0, -1, 1, 1, -1)
  ),
  adjust = "none"  # or "bonferroni", "holm", ...
)

```

```{r}
pairs(em, simple = "group", by = "time")

```



```{r}
df_dexa <- dexa_data %>% left_join(key_data, by ="id") %>% 
  select(id, group, sex, age, everything()) 
df_dexa
```




```{r}
model1 <- lmer(lean_g_total ~ time*group* sex + age + (1|id),data=df_dexa)
summary(model1)
```


```{r}
model1 <- lmer(fat_g_total ~ time*group + (1|id),data=df_dexa)
summary(model1)
```


```{r}
ggpaired(
  data       = df_dexa,
  x          = "time",
  y          = "lean_g_total",
  id         = "id",            # <--- specify your subject identifier here
  color      = "group",
  line.color = "gray",
  line.size  = 0.4,
  palette    = "npg",
  facet.by   = "group",
  ylab       = "g",
  xlab       = "time"
) +
  stat_compare_means(label = "p.format", paired = TRUE) +
  theme_prism()
```
